name: Backend CI/CD 1

on:
  pull_request:
    types: [opened, synchronize, closed]
    branches: [dev, main]

jobs:
  ci: # PR ëŒ€ìƒ: Full CI (Lint â†’ Build â†’ Test â†’ Artifact)
    # closedëŠ” ì œì™¸ (ë³‘í•© ì‹œì—ëŠ” CDë§Œ ì‹¤í–‰)
    if: github.event.action == 'opened' || github.event.action == 'synchronize'
    runs-on: ubuntu-latest
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. JDK í™˜ê²½ ì„¤ì • (ìºì‹± í¬í•¨)
      - name: Setup JDK 25
        uses: actions/setup-java@v5
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'gradle' # ì˜ì¡´ì„±: ~/.gradle/caches, ~/.gradle/wrapper ìºì‹±

      # 3. Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 4.Gradle ë¹Œë“œ ìºì‹œ (ì„ íƒì , ë” ë¹ ë¥¸ ë¹Œë“œ)
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3 # ë¹Œë“œ ìºì‹±

      # Phase 1: Lint (Checkstyle)
      - name: Run Checkstyle
        run: ./gradlew checkstyleMain checkstyleTest
        continue-on-error: true  # ì´ˆê¸°ì—” ê²½ê³ ë§Œ (ì ì§„ì  ê°œì„ )

      # Phase 2: Build
      - name: Build with Gradle
        run: ./gradlew build -x test

      # Phase 3: Test (TODO: í…ŒìŠ¤íŠ¸ ì‘ì„± í›„ í™œì„±í™”)
      - name: Run unit tests
        run: ./gradlew test

      # Phase 4: Artifact Upload
      # plane.jar ìƒì„±/ì €ì¥ ì•ˆí•˜ëŠ” ê²ƒì€ build.gradleì—ì„œ ì„¤ì •
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-${{ github.sha }}
          path: build/libs/*.jar
          retention-days: 14
          compression-level: 0  # JARëŠ” ì´ë¯¸ ì••ì¶•ë¨

      # Discord ì•Œë¦¼ ì¶”ê°€ ì˜ˆì • (ì„±ê³µ/ì‹¤íŒ¨ ëª¨ë‘ ì•Œë¦¼ + ì»¤ë°‹)
      - name: Notify Discord - CI Result
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          MENTION_USER: ${{ secrets.DISCORD_MENTION_USER_ID }}
        run: |
          STATUS="${{ job.status }}"  # job.statusë¡œ ë³€ê²½
          curl -s -X POST -H "Content-Type: application/json" \
            -d "{\"content\":\"ğŸ”¨ Backend CI **${STATUS}** | PR #${{ github.event.pull_request.number }} | \`${GITHUB_SHA:0:7}\`\"}" \
            "$DISCORD_WEBHOOK_URL"

  code-review: # í´ë¡œë“œ PR ì½”ë“œ ë¦¬ë·° ìë™í™”
    if: github.event.action == 'opened' || github.event.action == 'synchronize'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Claude AI Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            
            Please review this pull request with a focus on:
            - Code quality and best practices
            - Potential bugs or issues
            - Security implications
            - Performance considerations

            Note: The PR branch is already checked out in the current working directory.

            Use `gh pr comment` for top-level feedback.
            Use `mcp__github_inline_comment__create_inline_comment` to highlight specific code issues.
            Only post GitHub comments - don't submit review text as messages.

          claude_args: |
            --allowedTools "Read,LS,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),mcp__github_inline_comment__create_inline_comment"

  cd:
    if: github.event.pull_request.merged == true
    # needs: ci
    runs-on: ubuntu-latest
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ (íƒœê¹…ìš©)
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Git Tag ìƒì„± ìœ„í•´ ì „ì²´ íˆìŠ¤í† ë¦¬ í•„ìš”í•¨

      # 2. Artifact Download (ë³€ê²½)
      - name: Download JAR artifact
        uses: dawidd6/action-download-artifact@v6
        # ë‹¤ë¥¸ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ì˜ Artifactë„ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•œ ì»¤ìŠ¤í…€ ì•¡ì…˜
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: backend-ci.yml  # Artifactë¥¼ ìƒì„±í•œ ì›Œí¬í”Œë¡œìš° íŒŒì¼ëª…
          pr: ${{ github.event.pull_request.number }}  # PR ë²ˆí˜¸ë¡œ ê²€ìƒ‰
          workflow_conclusion: success # ì„±ê³µí•œ ì›Œí¬í”Œë¡œìš°ë§Œ ê²€ìƒ‰
          name_is_regexp: true # Artifact ì´ë¦„ì„ ì •ê·œí‘œí˜„ì‹ìœ¼ë¡œ ê²€ìƒ‰ trueëŠ” íŒ¨í„´ ë§¤ì¹­ ê°€ëŠ¥
          name: "backend-.*"
          path: ./artifacts

      # 3. íƒ€ì„ìŠ¤íƒ¬í”„ë¡œ JAR íŒŒì¼ëª… ë³€ê²½
      - name: Prepare JAR with timestamp
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          cd artifacts
          cd $(ls -d backend-* | head -n 1)
          JAR_FILE=$(ls *.jar | head -n 1)   
          mv $JAR_FILE ../../backend-${TIMESTAMP}.jar
          cd ../..
          echo "JAR_FILENAME=backend-${TIMESTAMP}.jar" >> $GITHUB_ENV
          echo "DEPLOY_TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV

      # 4. release/ ë””ë ‰í† ë¦¬ë¡œ JAR ì „ì†¡
      - name: Transfer JAR to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          source: "backend-${{ env.DEPLOY_TIMESTAMP }}.jar" # ì „ì†¡í•  íŒŒì¼
          target: "~/backend/release/"
          strip_components: 0 # ê²½ë¡œì—ì„œ ì œê±°í•  ë””ë ‰í† ë¦¬ ê¹Šì´: ì§€ê¸ˆ ì´ë¯¸ íŒŒì¼ëª…ë§Œ ìˆìŒ
          # 0: ì›ë³¸ ê²½ë¡œ ê·¸ëŒ€ë¡œ ìœ ì§€
          # 1: ì²« ë²ˆì§¸ ë””ë ‰í† ë¦¬ ì œê±° (artifacts/file.jar â†’ file.jar)

      # 5. ë°°í¬ ì‹¤í–‰ (ì‹¬ë³¼ë¦­ ë§í¬ ë°©ì‹)
      - name: Deploy via SSH
        id: deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            BACKEND_DIR="/home/system9902/backend"
            RELEASE_DIR="$BACKEND_DIR/release"
            NEW_JAR="$RELEASE_DIR/backend-${{ env.DEPLOY_TIMESTAMP }}.jar"
            CURRENT_LINK="$BACKEND_DIR/backend.jar"
            
            echo "1. ì„œë¹„ìŠ¤ ì¤‘ì§€"
            sudo systemctl stop backend || true
            
            echo "2. ìƒˆ JARë¡œ ì‹¬ë³¼ë¦­ ë§í¬ ìƒì„±"
            ln -sf $NEW_JAR $CURRENT_LINK
            ls -lh ~/backend/backend.jar 
            
            echo "3. ì„œë¹„ìŠ¤ ì‹œì‘"
            sudo systemctl start backend
            
            echo "4. ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸"
            sudo systemctl status backend --no-pager
            
            echo "5. í”„ë¡œì„¸ìŠ¤ ì‹œì‘ ëŒ€ê¸°"
            sleep 10

      # 6.Health Check
      - name: Health Check
        id: healthcheck
        uses: appleboy/ssh-action@v1.0.0
        continue-on-error: true
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "6. Health Check"
            MAX_RETRY=10
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRY ]; do
              if curl -f -s http://localhost:8080/actuator/health > /dev/null; then
                echo "Health check passed!"
                exit 0
              fi
            
              RETRY_COUNT=$((RETRY_COUNT+1))
              echo "Retry $RETRY_COUNT/$MAX_RETRY..."
              sleep 5
            done
            
            # fail ì‹œ ë¡¤ë°± + ë””ìŠ¤ì½”ë“œ ì•Œë¦¼ ì¶”ê°€ ì˜ˆì •

            echo "Health check failed!"
            tail -30 /home/system9902/backend/backend.log
            exit 1

      # 7. ì‹œë§¨í‹± ë²„ì „ íƒœê·¸ ìƒì„±
      - name: Create Semantic Version Tag
        if: |
          steps.healthcheck.outcome == 'success' && github.event.pull_request.base.ref == 'main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ìµœì‹  íƒœê·¸ ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ v0.0.0)
          # git describe --tags: ê°€ì¥ ê°€ê¹Œìš´ íƒœê·¸ ì°¾ê¸°
          # --abbrev=0: ì»¤ë°‹ í•´ì‹œ í‘œì‹œ ì•ˆ í•¨ (íƒœê·¸ë§Œ)
          LATEST_TAG=$(git describe --tags --abbrev=0 --match "v*.*.*" 2>/dev/null || echo "v0.0.0")
          echo "Latest tag: $LATEST_TAG"
          
          # ë²„ì „ íŒŒì‹±
          VERSION=${LATEST_TAG#v}
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)
          
          # Patch ë²„ì „ ìë™ ì¦ê°€ (0.0.0 â†’ 0.0.1)
          # ë‹¨ íŒ¨ì¹˜ë²„ì „ì— ëŒ€í•´ì„œë§Œ ê°€ëŠ¥, ë©”ì´ì €ì˜ ê²½ìš° ìˆ˜ë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ê°€ í•„ìš”
          PATCH=$((PATCH + 1))
          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          
          echo "New version: $NEW_VERSION"
          
          # Git ì„¤ì • (ì»¤ë°‹ ì‘ì„±ì ì •ë³´)
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # íƒœê·¸ ìƒì„± ë° í‘¸ì‹œ
          git tag -a $NEW_VERSION -m "Release $NEW_VERSION
          
          Deploy Timestamp: ${{ env.DEPLOY_TIMESTAMP }}
          JAR File: ${{ env.JAR_FILENAME }}
          Commit: ${{ github.sha }}
          PR: #${{ github.event.pull_request.number }}
          Merged by: ${{ github.event.pull_request.user.login }}"
          
          git push origin $NEW_VERSION
          echo "DEPLOY_TAG=$NEW_VERSION" >> $GITHUB_ENV
          echo "Tag created: $NEW_VERSION"

      # 8. ì˜¤ë˜ëœ release/ íŒŒì¼ ì •ë¦¬ (ë°°í¬ ì„±ê³µ ì‹œ)
      - name: Cleanup Old Releases
        if: steps.healthcheck.outcome == 'success'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            RELEASE_DIR="/home/system9902/backend/release"
            
            echo "Cleanup old releases"
            
            # ìµœê·¼ 5ê°œë§Œ ìœ ì§€, ë‚˜ë¨¸ì§€ ì‚­ì œ
            cd $RELEASE_DIR
            OLD_JARS=$(ls -t backend-*.jar | tail -n +6)
            
            if [ -n "$OLD_JARS" ]; then
              echo "Removing old releases:"
              echo "$OLD_JARS" | xargs -r rm -v
            else
              echo "No old releases to clean up"
            fi

      # 9. Discord ì•Œë¦¼ ì¶”ê°€ ì˜ˆì • (ì„±ê³µ/ì‹¤íŒ¨ ëª¨ë‘ ì•Œë¦¼ + ì»¤ë°‹)
      - name: Notify Discord - CI Result
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          MENTION_USER: ${{ secrets.DISCORD_MENTION_USER_ID }}
        run: |
          STATUS="${{ job.status }}"  # job.statusë¡œ ë³€ê²½
          curl -s -X POST -H "Content-Type: application/json" \
            -d "{\"content\":\"ğŸ”¨ Backend CI **${STATUS}** | PR #${{ github.event.pull_request.number }} | \`${GITHUB_SHA:0:7}\`\"}" \
            "$DISCORD_WEBHOOK_URL"
